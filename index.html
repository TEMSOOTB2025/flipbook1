<script>
  const TOTAL_PAGES = 158;
  let loadedPages = {};

  function getPageLabel(page, totalPages) {
    if (page === 1) return "Front Cover";
    if (page === 2 || page === 3) return "Introduction";
    if (page === totalPages) return "Back Cover";
    const left = page % 2 === 0 ? page : page - 1;
    const right = left + 1;
    return `Page ${left}-${right}`;
  }

  function loadPage(pageNumber, callback) {
    if (loadedPages[pageNumber]) return callback();

    const img = new Image();
    img.src = `pages/Page_${pageNumber}.png`;

    img.onload = function () {
      const pageDiv = $('<div />', { class: 'page' }).append(img);
      $('#flipbook').turn('addPage', pageDiv, pageNumber);
      loadedPages[pageNumber] = true;
      callback();
    };

    img.onerror = function () {
      const errorDiv = $('<div />', {
        class: 'page',
        html: `<p style="color:red; text-align:center; margin-top:40%;">Page ${pageNumber} failed to load.</p>`
      });
      $('#flipbook').turn('addPage', errorDiv, pageNumber);
      loadedPages[pageNumber] = true;
      callback();
    };
  }

  $(document).ready(function () {
    $('#flipbook').turn({
      width: $('#flipbook-wrapper').width(),
      height: $('#flipbook-wrapper').width() * 10 / 16,
      autoCenter: true,
      pages: TOTAL_PAGES,
      when: {
        turning: function (event, page) {
          $('#page-scrollbar').val(page);

          // Music overlay only on Page 23
          if (page === 23) {
            try {
              $('#music-overlay').fadeIn();
            } catch (e) {
              console.error("Music overlay error:", e);
            }
          } else {
            $('#music-overlay').fadeOut();
          }

          // Lazy load neighboring pages
          [page - 2, page - 1, page, page + 1, page + 2].forEach(p => {
            if (p >= 1 && p <= TOTAL_PAGES) {
              loadPage(p, function () {});
            }
          });
        }
      }
    });

    // Show and hide loader
    $('#flipbook').show();
    $('#loader').hide();

    // Preload first 10 pages
    for (let i = 1; i <= 10; i++) {
      loadPage(i, function () {});
    }

    // Scrollbar input tooltip
    $('#page-scrollbar').on('input', function () {
      const value = parseInt(this.value, 10);
      const tooltip = $('#scrollbar-tooltip');
      tooltip.text(getPageLabel(value, TOTAL_PAGES));

      const offset = $(this).offset();
      const width = $(this).width();
      const left = offset.left + (value - 1) / (TOTAL_PAGES - 1) * width;

      tooltip.css({
        left: left + 'px',
        top: (offset.top - 30) + 'px',
        display: 'block'
      });
    });

    // Scrollbar change turns page
    $('#page-scrollbar').on('change', function () {
      const page = parseInt(this.value, 10);
      $('#flipbook').turn('page', page);
      $('#scrollbar-tooltip').hide();
    });

    // Hide tooltip on mouse leave
    $('#page-scrollbar').on('mouseleave', function () {
      $('#scrollbar-tooltip').hide();
    });
  });
</script>
